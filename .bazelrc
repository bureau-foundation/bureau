# Bureau Bazel configuration.
# Per-user overrides go in .bazelrc.local (gitignored).

# Hermetic action environment: don't leak host env vars into build actions.
build --incompatible_strict_action_env

# Test output: only print on failure.
test --test_output=errors

# Tests that use tmux need:
#   TERM — tmux refuses to attach if the terminal lacks basic capabilities
#          ("terminal does not support clear")
#   LANG — tmux replaces control characters (tabs) with underscores in
#          format output under the C locale. A UTF-8 locale preserves them.
# Both are fixed values for hermeticity (remote execution workers produce
# identical results regardless of host locale or terminal).
test --test_env=TERM=xterm
test --test_env=LANG=C.UTF-8

# Go: static linking (no CGO).
build --@rules_go//go/config:pure

# Stamp binaries with version info.
build:release --stamp
build:release --workspace_status_command=script/bazel-workspace-status

# CI: suppress color and cursor control for log readability, and use a disk
# cache so that GitHub Actions can persist build artifacts across runs.
build:ci --color=no
build:ci --curses=no
build:ci --disk_cache=~/.cache/bazel-disk-cache
test:ci --test_output=errors

# Remote execution via Buildbarn (deploy/buildbarn/).
# Activate with: bazel build --config=remote //...
# The execution platform must match the worker's platform properties exactly
# (see deploy/buildbarn/bb-worker.jsonnet).
build:remote --remote_executor=grpc://localhost:8980
build:remote --jobs=64
build:remote --extra_execution_platforms=//:remote_linux_amd64
# Extend PATH for remote test actions so tests can find Nix-provided tools
# (tmux, etc.) mounted at /usr/local/bin in the runner container. Build
# actions keep the default PATH (/bin:/usr/bin) — they don't need external
# tools since the Go SDK is shipped via CAS.
test:remote --test_env=PATH=/bin:/usr/bin:/usr/local/bin

# Stress test configuration for flake detection.
# Runs each test multiple times and marks mixed pass/fail as FLAKY.
# Usage: sg docker -c "bazel test --config=stress //integration:integration_test"
test:stress --runs_per_test=10
test:stress --runs_per_test_detects_flakes
test:stress --test_output=all
test:stress --experimental_ui_max_stdouterr_bytes=10485760

# Import per-user local overrides if present.
try-import %workspace%/.bazelrc.local
