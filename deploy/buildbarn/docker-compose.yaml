services:
  storage-init:
    image: busybox:1.37
    container_name: bureau-bb-storage-init
    volumes:
      - bb-storage-cas:/storage-cas
      - bb-storage-ac:/storage-ac
    command:
      - sh
      - -c
      - |
        mkdir -p /storage-cas/persistent_state /storage-ac/persistent_state &&
        chmod 0700 /storage-cas /storage-cas/persistent_state /storage-ac /storage-ac/persistent_state

  storage:
    image: ghcr.io/buildbarn/bb-storage:20260210T042351Z-d641698
    container_name: bureau-bb-storage
    restart: unless-stopped
    depends_on:
      storage-init:
        condition: service_completed_successfully
    command:
      - /config/bb-storage.jsonnet
    ports:
      - "0.0.0.0:8980:8980"
      - "0.0.0.0:9980:9980"
    volumes:
      - ./bb-storage.jsonnet:/config/bb-storage.jsonnet:ro
      - bb-storage-cas:/storage-cas
      - bb-storage-ac:/storage-ac

  scheduler:
    image: ghcr.io/buildbarn/bb-scheduler:20260130T092441Z-749fb40
    container_name: bureau-bb-scheduler
    restart: unless-stopped
    depends_on:
      storage:
        condition: service_started
    command:
      - /config/bb-scheduler.jsonnet
    ports:
      - "0.0.0.0:7982:7982"
    volumes:
      - ./bb-scheduler.jsonnet:/config/bb-scheduler.jsonnet:ro

  runner-installer:
    image: ghcr.io/buildbarn/bb-runner-installer:20260130T092441Z-749fb40
    container_name: bureau-bb-runner-installer
    volumes:
      - bb-runner-bin:/bb

  worker-init:
    image: busybox:1.37
    container_name: bureau-bb-worker-init
    depends_on:
      runner-installer:
        condition: service_completed_successfully
    volumes:
      - bb-worker-data:/worker
    command:
      - sh
      - -c
      - |
        mkdir -p /worker/build /worker/cache &&
        chmod 0777 /worker/build &&
        chmod 0700 /worker/cache

  worker:
    image: ghcr.io/buildbarn/bb-worker:20260130T092441Z-749fb40
    container_name: bureau-bb-worker
    restart: unless-stopped
    depends_on:
      storage:
        condition: service_started
      scheduler:
        condition: service_started
      worker-init:
        condition: service_completed_successfully
    command:
      - /config/bb-worker.jsonnet
    volumes:
      - ./bb-worker.jsonnet:/config/bb-worker.jsonnet:ro
      - bb-worker-data:/worker

  runner:
    image: ubuntu:24.04
    container_name: bureau-bb-runner
    restart: unless-stopped
    init: true
    depends_on:
      runner-installer:
        condition: service_completed_successfully
      worker-init:
        condition: service_completed_successfully
    command:
      - /bb/bb_runner
      - /config/bb-runner.jsonnet
    network_mode: none
    volumes:
      - ./bb-runner.jsonnet:/config/bb-runner.jsonnet:ro
      - bb-runner-bin:/bb:ro
      - bb-worker-data:/worker

volumes:
  bb-storage-cas:
  bb-storage-ac:
  bb-runner-bin:
  bb-worker-data:
