services:
  matrix:
    image: ghcr.io/continuwuity/continuwuity:latest
    container_name: bureau-matrix
    restart: unless-stopped
    ports:
      - "0.0.0.0:6167:6167"
    volumes:
      - matrix-data:/var/lib/continuwuity
      - ./continuwuity.toml:/etc/conduwuit/conduwuit.toml:ro
    environment:
      CONDUWUIT_CONFIG: "/etc/conduwuit/conduwuit.toml"
      CONTINUWUITY_SERVER_NAME: "${BUREAU_MATRIX_SERVER_NAME:-bureau.local}"
      CONTINUWUITY_REGISTRATION_TOKEN: "${BUREAU_MATRIX_REGISTRATION_TOKEN}"
      CONTINUWUITY_ALLOW_REGISTRATION: "true"
      CONTINUWUITY_ALLOW_FEDERATION: "false"
      CONTINUWUITY_TURN_URIS: '["turn:${BUREAU_TURN_HOST:-localhost}:3478?transport=udp","turn:${BUREAU_TURN_HOST:-localhost}:3478?transport=tcp"]'
      CONTINUWUITY_TURN_SECRET: "${BUREAU_TURN_SECRET}"

  turn:
    image: coturn/coturn:latest
    container_name: bureau-turn
    restart: unless-stopped
    # host networking is required for coturn to correctly detect external
    # IPs and relay UDP traffic. Docker's port mapping for large UDP ranges
    # (49152-65535) is prohibitively expensive and unreliable.
    network_mode: host
    volumes:
      - ./turnserver.conf:/etc/turnserver.conf:ro
    command: ["-c", "/etc/turnserver.conf"]

  attic:
    image: ghcr.io/zhaofengli/attic:latest
    container_name: bureau-attic
    restart: unless-stopped
    ports:
      - "0.0.0.0:5580:5580"
    volumes:
      - attic-data:/var/lib/attic
      - ./attic.toml:/etc/attic/server.toml:ro
    command: ["-f", "/etc/attic/server.toml"]
    environment:
      ATTIC_SERVER_TOKEN_HS256_SECRET_BASE64: "${BUREAU_ATTIC_TOKEN_SECRET}"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5580 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 10s

volumes:
  matrix-data:
  attic-data:
