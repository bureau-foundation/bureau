# Integration test stack for Bureau.
#
# Provides an isolated Continuwuity homeserver for automated testing.
# All values are hardcoded â€” no .env file needed. The server name
# (test.bureau.local) and registration token are test-only constants
# that must never be used in production.
#
# Usage:
#   sg docker -c "docker compose -p bureau-test up -d"
#   PORT=$(docker compose -p bureau-test port matrix 6167 | cut -d: -f2)
#   bureau matrix setup \
#     --homeserver http://localhost:$PORT \
#     --server-name test.bureau.local \
#     --registration-token-file <(echo test-registration-token) \
#     --credential-file ./bureau-creds
#   bureau matrix doctor --credential-file ./bureau-creds --server-name test.bureau.local
#   sg docker -c "docker compose -p bureau-test down -v"
#
# The host port is dynamically allocated (0:6167) so multiple test
# runs can execute in parallel without port collisions.

services:
  matrix:
    image: ghcr.io/continuwuity/continuwuity:latest
    restart: "no"
    ports:
      - "127.0.0.1:0:6167"
    volumes:
      - test-matrix-data:/var/lib/continuwuity
      - ./continuwuity.toml:/etc/conduwuit/conduwuit.toml:ro
    environment:
      CONDUWUIT_CONFIG: "/etc/conduwuit/conduwuit.toml"
      CONTINUWUITY_SERVER_NAME: "test.bureau.local"
      CONTINUWUITY_REGISTRATION_TOKEN: "test-registration-token"
      CONTINUWUITY_ALLOW_REGISTRATION: "true"
      CONTINUWUITY_ALLOW_FEDERATION: "false"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6167/_matrix/client/versions || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

volumes:
  test-matrix-data:
