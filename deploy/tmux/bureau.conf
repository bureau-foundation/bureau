# Bureau tmux configuration
# SPDX-License-Identifier: Apache-2.0
#
# Applied to Bureau-managed tmux sessions via:
#   tmux -S /run/bureau/tmux.sock -f deploy/tmux/bureau.conf new-session ...
#
# Bureau runs a dedicated tmux server (separate socket), so this config
# is completely isolated from the user's personal tmux. It must NOT
# source any user config files (~/.tmux.conf, XDG paths, etc.).

# --- Prefix key ---
# Ctrl-a for Bureau sessions. The user's local tmux keeps Ctrl-b.
# This eliminates the double-prefix problem when observing remote
# sessions through a local tmux: Ctrl-b is always local, Ctrl-a
# is always remote.
set-option -g prefix C-a
unbind-key C-b
bind-key C-a send-prefix

# --- Terminal capabilities ---
set-option -g default-terminal "tmux-256color"

# Pass through RGB/truecolor escape sequences so TUI applications
# (Claude Code, delta, bat, etc.) render correctly.
set-option -ga terminal-features ",tmux-256color:RGB"

# --- Input ---
# Mouse support is required for observation: clicks select remote panes,
# scroll events pass through to TUI applications, drag resizes remote
# pane borders.
set-option -g mouse on

# Minimal escape-time so that Escape key presses in vim/neovim register
# instantly rather than waiting for a potential escape sequence.
set-option -g escape-time 10

# Allow applications to set the clipboard via OSC 52.
set-option -g set-clipboard on

# --- Scrollback ---
# 50000 lines covers hours of typical agent activity. The ring buffer
# in bureau-observe-relay provides network-level history replay; this
# buffer is for the tmux session's own scrollback (used when attaching
# directly or when the relay reads scrollback on connect).
set-option -g history-limit 50000

# --- Visual behavior ---
# No bells. Agent sessions produce no meaningful bell events, and stray
# bells from terminal applications are disruptive.
set-option -g visual-bell off
set-option -g visual-activity off
set-option -g bell-action none

# Don't display tmux messages for longer than necessary.
set-option -g display-time 2000
set-option -g display-panes-time 1000

# --- Window/pane behavior ---
# Renumber windows when one is closed so there are no gaps.
set-option -g renumber-windows on

# Start window and pane numbering at 1 (0 is far from the prefix key).
set-option -g base-index 1
set-option -g pane-base-index 1

# Keep windows alive when their child process exits so that crash
# output remains visible for debugging.
set-option -g remain-on-exit on

# Automatically rename windows based on the running command.
set-option -g automatic-rename on

# --- Status bar ---
# Minimal, informative status bar showing the principal identity.
#
# The launcher sets tmux user options per-session after creation:
#   tmux -S ... set-option -t <session> @bureau_principal "iree/amdgpu/pm"
#   tmux -S ... set-option -t <session> @bureau_machine "machine/workstation"
#
# User options (@ prefix) are tmux-native and expand in format strings
# without spawning a shell subprocess.
set-option -g status on
set-option -g status-interval 5
set-option -g status-position bottom

# Left: principal name (from launcher-set user option), falling back to
# the tmux session name if the option hasn't been set.
set-option -g status-left-length 60
set-option -g status-left " #{?@bureau_principal,#{@bureau_principal},#{session_name}} "

# Right: machine name and time.
set-option -g status-right-length 60
set-option -g status-right " #{?@bureau_machine,#{@bureau_machine},} %H:%M "

# Colors: understated so the status bar doesn't compete with agent output.
set-option -g status-style "bg=colour235,fg=colour248"
set-option -g status-left-style "bg=colour238,fg=colour252,bold"
set-option -g status-right-style "bg=colour238,fg=colour248"

# Active/inactive window indicators in the status bar.
set-option -g window-status-current-style "bg=colour240,fg=colour255,bold"
set-option -g window-status-style "bg=colour235,fg=colour244"

# Pane borders: subtle so they don't distract.
set-option -g pane-border-style "fg=colour238"
set-option -g pane-active-border-style "fg=colour248"

# --- Key bindings ---
# Reload this config (useful during development).
bind-key r source-file deploy/tmux/bureau.conf \; display-message "bureau.conf reloaded"

# Intuitive pane splitting: | for vertical, - for horizontal.
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# New windows inherit the current pane's working directory.
bind-key c new-window -c "#{pane_current_path}"

# Vim-style pane navigation.
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Pane resize with uppercase vim keys.
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5
