#!/bin/bash
# Copyright 2026 The Bureau Authors
# SPDX-License-Identifier: Apache-2.0

# Detect bead IDs in source files. Bead IDs (like bd-3vx) are ephemeral local
# tracking state that must never appear in committed code, comments, or
# documentation.

set -euo pipefail

matches=$(grep -rn \
    --include="*.go" \
    --include="*.py" \
    --include="*.sh" \
    --include="*.md" \
    --include="*.yaml" \
    --include="*.yml" \
    --include="*.nix" \
    -E "\bbd-[a-z0-9]{2,12}\b" \
    . 2>/dev/null || true)

# Filter out files that legitimately discuss beads as a concept, and
# directories that are gitignored (local-only state). The ticketui
# package renders beads data â€” its test fixtures, format examples,
# and column width constants naturally contain bd-XXX patterns.
filtered=$(echo "$matches" \
    | grep -v "^\./.beads/" \
    | grep -v "^\./.bv/" \
    | grep -v "^\./.notes/" \
    | grep -v "^\./lib/ticketui/" \
    | grep -v "CONTRIBUTING.md" \
    | grep -v "CLAUDE.md" \
    | grep -v ".pre-commit-config.yaml" \
    | grep -v "check-bead-references" \
    || true)

if [ -n "$filtered" ]; then
    echo ""
    echo "ERROR: Bead IDs found in code:"
    echo "$filtered"
    echo ""
    echo "Comments and code must be timeless - describe what the code does"
    echo "and why, not the process involved in writing it."
    exit 1
fi

exit 0
