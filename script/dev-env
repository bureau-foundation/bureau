#!/usr/bin/env bash
# Copyright 2026 The Bureau Authors
# SPDX-License-Identifier: Apache-2.0
#
# Build all Bureau host binaries and print a PATH export.
#
# Usage:
#   eval "$(script/dev-env)"
#
# Builds bureau-host-env from the current worktree (cached after first
# build) and outputs an export line that puts all Bureau binaries on
# PATH. Progress and errors go to stderr so eval is safe even on failure.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if ! command -v nix &>/dev/null; then
    echo "Error: nix not found. Run script/setup-nix first." >&2
    exit 1
fi

echo "Building bureau-host-env..." >&2
HOST_ENV=$(nix build "$REPO_ROOT#bureau-host-env" --print-out-paths --no-link)

if [ ! -d "$HOST_ENV/bin" ]; then
    echo "Error: build produced no bin/ directory at $HOST_ENV" >&2
    exit 1
fi

echo "Built: $HOST_ENV" >&2
echo "export PATH=$HOST_ENV/bin:\$PATH"
